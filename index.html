<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Tagebuch</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { ChevronLeft, ChevronRight, Calendar, Settings, Sun, Moon, Search, X, BookOpen, Heart, Star, Download, Upload, FileText } = lucide;

        const DiaryApp = () => {
          const [currentDate, setCurrentDate] = useState(new Date());
          const [entries, setEntries] = useState({});
          const [fieldTitles, setFieldTitles] = useState(['Ereignisse', 'Gedanken', 'Dankbarkeit']);
          const [showCalendar, setShowCalendar] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
          const [isDarkMode, setIsDarkMode] = useState(() => {
            const saved = localStorage?.getItem('diary-theme');
            return saved ? JSON.parse(saved) : false;
          });
          const [isEditingTitles, setIsEditingTitles] = useState(false);
          const [showSearch, setShowSearch] = useState(false);
          const [searchQuery, setSearchQuery] = useState('');
          const [searchResults, setSearchResults] = useState([]);
          const [fuzzySearchEnabled, setFuzzySearchEnabled] = useState(true);
          const [saveTimeout, setSaveTimeout] = useState(null);
          const [saveStatus, setSaveStatus] = useState('saved');
          const [showImportExport, setShowImportExport] = useState(false);
          const [importStatus, setImportStatus] = useState('');

          // Save to localStorage
          const saveToStorage = (data) => {
            try {
              const encrypted = btoa(JSON.stringify(data));
              localStorage.setItem('diary-entries', encrypted);
              localStorage.setItem('diary-field-titles', JSON.stringify(fieldTitles));
              return true;
            } catch (error) {
              console.error('Failed to save to storage:', error);
              return false;
            }
          };

          // Load from localStorage
          const loadFromStorage = () => {
            try {
              const encryptedEntries = localStorage.getItem('diary-entries');
              const savedTitles = localStorage.getItem('diary-field-titles');
              
              if (encryptedEntries) {
                const decrypted = JSON.parse(atob(encryptedEntries));
                setEntries(decrypted);
              }
              
              if (savedTitles) {
                setFieldTitles(JSON.parse(savedTitles));
              }
            } catch (error) {
              console.error('Failed to load from storage:', error);
            }
          };

          useEffect(() => {
            loadFromStorage();
          }, []);

          useEffect(() => {
            if (fieldTitles.length > 0) {
              try {
                localStorage.setItem('diary-field-titles', JSON.stringify(fieldTitles));
              } catch (error) {
                console.log('Could not save field titles');
              }
            }
          }, [fieldTitles]);

          useEffect(() => {
            try {
              localStorage?.setItem('diary-theme', JSON.stringify(isDarkMode));
            } catch (error) {
              console.log('Could not save theme preference');
            }
          }, [isDarkMode]);

          const formatDate = (date) => {
            return date.toISOString().split('T')[0];
          };

          const getCurrentEntry = () => {
            const dateKey = formatDate(currentDate);
            return entries[dateKey] || { field1: '', field2: '', field3: '', mood: null };
          };

          const updateEntry = useCallback((field, value) => {
            const dateKey = formatDate(currentDate);
            setSaveStatus('saving');
            
            const newEntries = {
              ...entries,
              [dateKey]: {
                ...getCurrentEntry(),
                [field]: value
              }
            };
            setEntries(newEntries);

            if (saveTimeout) {
              clearTimeout(saveTimeout);
            }

            const timeout = setTimeout(() => {
              const saved = saveToStorage(newEntries);
              setSaveStatus(saved ? 'saved' : 'error');
              console.log('Auto-saved entry for', dateKey);
            }, 1000);
            setSaveTimeout(timeout);
          }, [currentDate, entries, saveTimeout]);

          const updateMood = (moodValue) => {
            updateEntry('mood', moodValue);
          };

          // Excel Export Function
          const exportToExcel = () => {
            try {
              const excelData = [];
              
              excelData.push([
                'Datum',
                fieldTitles[0] || 'Feld 1',
                fieldTitles[1] || 'Feld 2',
                fieldTitles[2] || 'Feld 3',
                'Stimmungsscore'
              ]);

              const sortedEntries = Object.entries(entries).sort(([a], [b]) => new Date(a) - new Date(b));

              sortedEntries.forEach(([date, entry]) => {
                excelData.push([
                  date,
                  entry.field1 || '',
                  entry.field2 || '',
                  entry.field3 || '',
                  entry.mood || ''
                ]);
              });

              const wb = XLSX.utils.book_new();
              const ws = XLSX.utils.aoa_to_sheet(excelData);

              ws['!cols'] = [
                { width: 12 },
                { width: 30 },
                { width: 30 },
                { width: 30 },
                { width: 15 }
              ];

              XLSX.utils.book_append_sheet(wb, ws, 'Tagebuch');

              const fileName = `Tagebuch_Export_${new Date().toISOString().split('T')[0]}.xlsx`;
              XLSX.writeFile(wb, fileName);

              console.log('Excel file exported successfully');
            } catch (error) {
              console.error('Error exporting to Excel:', error);
              alert('Fehler beim Exportieren. Bitte versuchen Sie es erneut.');
            }
          };

          // Excel Import Function
          const importFromExcel = (file) => {
            return new Promise((resolve, reject) => {
              const reader = new FileReader();
              
              reader.onload = (e) => {
                try {
                  const data = new Uint8Array(e.target.result);
                  const workbook = XLSX.read(data, { type: 'array' });
                  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                  const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                  if (jsonData.length < 2) {
                    reject('Excel-Datei ist leer oder hat nicht genügend Daten');
                    return;
                  }

                  const headers = jsonData[0];
                  const dataRows = jsonData.slice(1);

                  const dateIndex = headers.findIndex(h => 
                    h && h.toString().toLowerCase().includes('datum')
                  );
                  const moodIndex = headers.findIndex(h => 
                    h && h.toString().toLowerCase().includes('stimmung')
                  );

                  if (dateIndex === -1) {
                    reject('Keine Datumsspalte gefunden. Bitte stellen Sie sicher, dass eine Spalte "Datum" enthält.');
                    return;
                  }

                  const importedEntries = {};
                  const importedFieldTitles = [];

                  headers.forEach((header, index) => {
                    if (index !== dateIndex && index !== moodIndex && header && header.toString().trim()) {
                      importedFieldTitles.push(header.toString().trim());
                    }
                  });

                  if (importedFieldTitles.length > 3) {
                    importedFieldTitles.splice(3);
                  }

                  dataRows.forEach(row => {
                    if (row[dateIndex]) {
                      let dateStr = row[dateIndex];
                      
                      if (typeof dateStr === 'number') {
                        const excelDate = new Date((dateStr - 25569) * 86400 * 1000);
                        dateStr = excelDate.toISOString().split('T')[0];
                      } else if (typeof dateStr === 'string') {
                        const parsedDate = new Date(dateStr);
                        if (!isNaN(parsedDate.getTime())) {
                          dateStr = parsedDate.toISOString().split('T')[0];
                        } else {
                          const germanMatch = dateStr.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
                          if (germanMatch) {
                            const [, day, month, year] = germanMatch;
                            dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                          }
                        }
                      }

                      const entry = {};
                      let fieldIndex = 1;

                      headers.forEach((header, colIndex) => {
                        if (colIndex !== dateIndex && colIndex !== moodIndex && fieldIndex <= 3) {
                          entry[`field${fieldIndex}`] = row[colIndex] || '';
                          fieldIndex++;
                        }
                      });

                      if (moodIndex !== -1 && row[moodIndex]) {
                        const moodValue = parseInt(row[moodIndex]);
                        if (moodValue >= 1 && moodValue <= 3) {
                          entry.mood = moodValue;
                        }
                      }

                      importedEntries[dateStr] = entry;
                    }
                  });

                  resolve({
                    entries: importedEntries,
                    fieldTitles: importedFieldTitles.length > 0 ? importedFieldTitles : fieldTitles
                  });
                } catch (error) {
                  reject('Fehler beim Lesen der Excel-Datei: ' + error.message);
                }
              };

              reader.onerror = () => reject('Fehler beim Lesen der Datei');
              reader.readAsArrayBuffer(file);
            });
          };

          const handleFileImport = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setImportStatus('');
            
            try {
              const result = await importFromExcel(file);
              
              const mergedEntries = { ...entries, ...result.entries };
              setEntries(mergedEntries);
              setFieldTitles(result.fieldTitles);
              
              saveToStorage(mergedEntries);
              
              setImportStatus('success');
              setTimeout(() => setImportStatus(''), 3000);
              
              console.log(`Successfully imported ${Object.keys(result.entries).length} entries`);
            } catch (error) {
              console.error('Import error:', error);
              setImportStatus('error');
              setTimeout(() => setImportStatus(''), 5000);
              alert('Import-Fehler: ' + error);
            }

            event.target.value = '';
          };

          const levenshteinDistance = (str1, str2) => {
            if (str1.length === 0) return str2.length;
            if (str2.length === 0) return str1.length;
            
            const matrix = Array(str2.length + 1).fill(null).map(() => Array(str1.length + 1).fill(null));
            
            for (let i = 0; i <= str1.length; i++) matrix[0][i] = i;
            for (let j = 0; j <= str2.length; j++) matrix[j][0] = j;
            
            for (let j = 1; j <= str2.length; j++) {
              for (let i = 1; i <= str1.length; i++) {
                const substitutionCost = str1[i - 1] === str2[j - 1] ? 0 : 1;
                matrix[j][i] = Math.min(
                  matrix[j - 1][i] + 1,
                  matrix[j][i - 1] + 1,
                  matrix[j - 1][i - 1] + substitutionCost
                );
              }
            }
            
            return matrix[str2.length][str1.length];
          };

          const isFuzzyMatch = (searchTerm, text) => {
            if (!fuzzySearchEnabled) {
              return text.toLowerCase().includes(searchTerm.toLowerCase());
            }

            const words = text.toLowerCase().split(/\s+/);
            const searchTermLower = searchTerm.toLowerCase();
            
            if (text.toLowerCase().includes(searchTermLower)) {
              return true;
            }
            
            for (const word of words) {
              if (word.length < 3 || searchTermLower.length < 3) continue;
              
              const distance = levenshteinDistance(searchTermLower, word);
              const maxDistance = Math.floor(Math.max(searchTermLower.length, word.length) * 0.3);
              
              if (distance <= maxDistance && distance <= 2) {
                return true;
              }
            }
            
            return false;
          };

          const goToPreviousDay = () => {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() - 1);
            setCurrentDate(newDate);
          };

          const goToNextDay = () => {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + 1);
            setCurrentDate(newDate);
          };

          const formatDisplayDate = (date) => {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
              return 'Heute';
            } else if (date.toDateString() === yesterday.toDateString()) {
              return 'Gestern';
            }
            
            return date.toLocaleDateString('de-DE', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
          };

          const toggleTheme = () => {
            setIsDarkMode(!isDarkMode);
          };

          const getMoodDisplay = (mood) => {
            switch(mood) {
              case 1: return { emoji: '😔', label: 'Schlecht', color: 'text-red-500' };
              case 2: return { emoji: '😐', label: 'Normal', color: 'text-yellow-500' };
              case 3: return { emoji: '😊', label: 'Gut', color: 'text-green-500' };
              default: return { emoji: '❓', label: 'Nicht bewertet', color: 'text-gray-400' };
            }
          };

          const performSearch = (query) => {
            if (!query.trim()) {
              setSearchResults([]);
              return;
            }

            const results = [];
            const searchTerm = query.toLowerCase();

            Object.entries(entries).forEach(([dateKey, entry]) => {
              const matchingFields = [];
              
              fieldTitles.forEach((title, index) => {
                const fieldValue = entry[`field${index + 1}`] || '';
                if (isFuzzyMatch(searchTerm, fieldValue)) {
                  let context = '';
                  if (fuzzySearchEnabled && !fieldValue.toLowerCase().includes(searchTerm)) {
                    context = fieldValue.length > 60 ? fieldValue.substring(0, 60) + '...' : fieldValue;
                  } else {
                    const matchIndex = fieldValue.toLowerCase().indexOf(searchTerm);
                    const start = Math.max(0, matchIndex - 30);
                    const end = Math.min(fieldValue.length, matchIndex + searchTerm.length + 30);
                    context = fieldValue.substring(start, end);
                    
                    if (start > 0) context = '...' + context;
                    if (end < fieldValue.length) context = context + '...';
                  }
                  
                  matchingFields.push({
                    title,
                    context,
                    fullText: fieldValue,
                    isFuzzy: fuzzySearchEnabled && !fieldValue.toLowerCase().includes(searchTerm)
                  });
                }
              });

              const moodSearches = {
                'schlecht': 1, 'traurig': 1, 'down': 1,
                'normal': 2, 'okay': 2, 'ok': 2,
                'gut': 3, 'super': 3, 'toll': 3, 'großartig': 3
              };
              
              if (moodSearches[searchTerm] && entry.mood === moodSearches[searchTerm]) {
                const moodDisplay = getMoodDisplay(entry.mood);
                matchingFields.push({
                  title: 'Stimmung',
                  context: `${moodDisplay.emoji} ${moodDisplay.label}`,
                  fullText: moodDisplay.label,
                  isFuzzy: false
                });
              }

              if (matchingFields.length > 0) {
                results.push({
                  date: dateKey,
                  displayDate: new Date(dateKey + 'T00:00:00').toLocaleDateString('de-DE', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                  }),
                  matches: matchingFields,
                  mood: entry.mood
                });
              }
            });

            results.sort((a, b) => new Date(b.date) - new Date(a.date));
            setSearchResults(results);
          };

          const handleSearch = (query) => {
            setSearchQuery(query);
            performSearch(query);
          };

          const goToDate = (dateString) => {
            setCurrentDate(new Date(dateString + 'T00:00:00'));
            setShowSearch(false);
            setSearchQuery('');
            setSearchResults([]);
          };

          const getEntryIcon = (index) => {
            const icons = [BookOpen, Heart, Star];
            const Icon = icons[index] || BookOpen;
            return React.createElement(Icon, { className: "w-4 h-4 opacity-50" });
          };

          const getSaveStatusIndicator = () => {
            switch(saveStatus) {
              case 'saving':
                return (
                  <div className="flex items-center space-x-2 text-xs opacity-50">
                    <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-current"></div>
                    <span>Speichern...</span>
                  </div>
                );
              case 'saved':
                return (
                  <p className="text-xs opacity-50">
                    Automatisch gespeichert
                  </p>
                );
              case 'error':
                return (
                  <p className="text-xs text-red-500">
                    Fehler beim Speichern
                  </p>
                );
              default:
                return null;
            }
          };

          const currentEntry = getCurrentEntry();
          const hasEntryForToday = Object.values(currentEntry).some(value => 
            value !== null && value !== undefined && value !== ''
          );

          return (
            <div className={`min-h-screen transition-all duration-300 ${
              isDarkMode ? 'bg-gradient-to-br from-gray-900 to-gray-800 text-white' : 'bg-gradient-to-br from-blue-50 to-indigo-100 text-gray-900'
            }`}>
              {/* Header */}
              <div className={`sticky top-0 z-10 backdrop-blur-xl border-b transition-all duration-300 ${
                isDarkMode ? 'bg-gray-900/90 border-gray-700' : 'bg-white/90 border-gray-200'
              }`}>
                <div className="flex items-center justify-between p-4">
                  <button
                    onClick={() => setShowSettings(!showSettings)}
                    className={`p-3 rounded-xl transition-all duration-200 ${
                      isDarkMode ? 'hover:bg-gray-700 active:scale-95' : 'hover:bg-gray-100 active:scale-95'
                    }`}
                  >
                    <Settings className="w-5 h-5" />
                  </button>
                  
                  <div className="flex items-center space-x-2">
                    <BookOpen className="w-6 h-6 text-blue-500" />
                    <h1 className="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                      Mein Tagebuch
                    </h1>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setShowImportExport(!showImportExport)}
                      className={`p-3 rounded-xl transition-all duration-200 ${
                        showImportExport 
                          ? 'bg-green-500 text-white shadow-lg' 
                          : isDarkMode ? 'hover:bg-gray-700 active:scale-95' : 'hover:bg-gray-100 active:scale-95'
                      }`}
                    >
                      <FileText className="w-5 h-5" />
                    </button>
                    <button
                      onClick={() => setShowSearch(!showSearch)}
                      className={`p-3 rounded-xl transition-all duration-200 ${
                        showSearch 
                          ? 'bg-blue-500 text-white shadow-lg' 
                          : isDarkMode ? 'hover:bg-gray-700 active:scale-95' : 'hover:bg-gray-100 active:scale-95'
                      }`}
                    >
                      <Search className="w-5 h-5" />
                    </button>
                    <button
                      onClick={toggleTheme}
                      className={`p-3 rounded-xl transition-all duration-200 ${
                        isDarkMode ? 'hover:bg-gray-700 active:scale-95' : 'hover:bg-gray-100 active:scale-95'
                      }`}
                    >
                      {isDarkMode ? <Sun className="w-5 h-5 text-yellow-400" /> : <Moon className="w-5 h-5 text-purple-600" />}
                    </button>
                  </div>
                </div>

                {/* Date Navigation */}
                <div className="flex items-center justify-between p-4 pt-0">
                  <button
                    onClick={goToPreviousDay}
                    className={`p-3 rounded-xl transition-all duration-200 ${
                      isDarkMode ? 'hover:bg-gray-700 active:scale-95' : 'hover:bg-gray-100 active:scale-95'
                    }`}
                  >
                    <ChevronLeft className="w-5 h-5" />
                  </button>

                  <button
                    onClick={() => setShowCalendar(!showCalendar)}
                    className={`flex items-center space-x-3 px-6 py-3 rounded-xl transition-all duration-200 ${
                      isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'
                    }`}
                  >
                    <Calendar className="w-4 h-4" />
                    <div className="text-center">
                      <span className="text-sm font-bold block">
                        {formatDisplayDate(currentDate)}
                      </span>
                      {hasEntryForToday && (
                        <div className="flex items-center justify-center mt-1">
                          <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                        </div>
                      )}
                    </div>
                  </button>

                  <button
                    onClick={goToNextDay}
                    className={`p-3 rounded-xl transition-all duration-200 ${
                      isDarkMode ? 'hover:bg-gray-700 active:scale-95' : 'hover:bg-gray-100 active:scale-95'
                    }`}
                  >
                    <ChevronRight className="w-5 h-5" />
                  </button>
                </div>
              </div>

              {/* Import/Export Panel */}
              {showImportExport && (
                <div className={`border-b transition-all duration-300 ${
                  isDarkMode ? 'bg-gray-800/95 border-gray-700' : 'bg-white/95 border-gray-200'
                }`}>
                  <div className="p-4">
                    <div className="space-y-6">
                      <div className="flex items-center justify-between">
                        <h3 className="text-lg font-bold">Import & Export</h3>
                        <div className="text-xs opacity-60">
                          Excel Format (.xlsx)
                        </div>
                      </div>

                      {/* Export Section */}
                      <div className="space-y-3">
                        <h4 className="font-semibold flex items-center space-x-2">
                          <Download className="w-4 h-4" />
                          <span>Daten exportieren</span>
                        </h4>
                        <p className="text-sm opacity-70">
                          Alle Tagebucheinträge als Excel-Datei herunterladen
                        </p>
                        <button
                          onClick={exportToExcel}
                          className={`w-full p-3 rounded-xl font-medium transition-all duration-200 ${
                            isDarkMode
                              ? 'bg-blue-600 hover:bg-blue-700 text-white'
                              : 'bg-blue-500 hover:bg-blue-600 text-white'
                          } shadow-md hover:shadow-lg`}
                        >
                          <div className="flex items-center justify-center space-x-2">
                            <Download className="w-4 h-4" />
                            <span>Excel-Datei erstellen</span>
                          </div>
                        </button>
                      </div>

                      {/* Import Section */}
                      <div className="space-y-3">
                        <h4 className="font-semibold flex items-center space-x-2">
                          <Upload className="w-4 h-4" />
                          <span>Daten importieren</span>
                        </h4>
                        <p className="text-sm opacity-70">
                          Excel-Datei mit Spalten: Datum, {fieldTitles.join(', ')}, Stimmungsscore
                        </p>
                        
                        {importStatus === 'success' && (
                          <div className="p-3 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-xl text-sm">
                            ✅ Import erfolgreich abgeschlossen!
                          </div>
                        )}
                        
                        {importStatus === 'error' && (
                          <div className="p-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-xl text-sm">
                            ❌ Import fehlgeschlagen. Bitte prüfen Sie das Dateiformat.
                          </div>
                        )}

                        <div className="relative">
                          <input
                            type="file"
                            accept=".xlsx,.xls"
                            onChange={handleFileImport}
                            className="hidden"
                            id="excel-import"
                          />
                          <label
                            htmlFor="excel-import"
                            className={`w-full p-3 rounded-xl font-medium transition-all duration-200 cursor-pointer block text-center ${
                              isDarkMode
                                ? 'bg-green-600 hover:bg-green-700 text-white'
                                : 'bg-green-500 hover:bg-green-600 text-white'
                            } shadow-md hover:shadow-lg`}
                          >
                            <div className="flex items-center justify-center space-x-2">
                              <Upload className="w-4 h-4" />
                              <span>Excel-Datei auswählen</span>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Search Panel */}
              {showSearch && (
                <div className={`border-b transition-all duration-300 transform ${
                  isDarkMode ? 'bg-gray-800/95 border-gray-700' : 'bg-white/95 border-gray-200'
                }`}>
                  <div className="p-4">
                    <div className="relative">
                      <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 opacity-50" />
                      <input
                        type="text"
                        value={searchQuery}
                        onChange={(e) => handleSearch(e.target.value)}
                        placeholder="Durchsuche alle Einträge..."
                        className={`w-full pl-12 pr-12 py-4 rounded-2xl border-0 transition-all duration-200 text-base ${
                          isDarkMode
                            ? 'bg-gray-700 text-white placeholder-gray-400 focus:bg-gray-600'
                            : 'bg-gray-100 text-gray-900 placeholder-gray-500 focus:bg-white'
                        } focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm focus:shadow-lg`}
                        autoFocus
                      />
                      {searchQuery && (
                        <button
                          onClick={() => {
                            setSearchQuery('');
                            setSearchResults([]);
                          }}
                          className="absolute right-4 top-1/2 transform -translate-y-1/2 p-2 rounded-full hover:bg-gray-600 transition-colors"
                        >
                          <X className="w-4 h-4" />
                        </button>
                      )}
                    </div>
                    
                    {/* Fuzzy Search Toggle */}
                    <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-300 dark:border-gray-600">
                      <div className="flex items-center space-x-3">
                        <span className="text-sm font-medium">Schreibfehler tolerieren</span>
                        <div className="text-xs opacity-60">
                          {fuzzySearchEnabled ? '(z.B. "fahrd" → "fahrrad")' : '(nur exakte Treffer)'}
                        </div>
                      </div>
                      <button
                        onClick={() => {
                          setFuzzySearchEnabled(!fuzzySearchEnabled);
                          if (searchQuery) {
                            setTimeout(() => performSearch(searchQuery), 100);
                          }
                        }}
                        className={`relative inline-flex h-7 w-12 items-center rounded-full transition-all duration-200 ${
                          fuzzySearchEnabled
                            ? 'bg-blue-500 shadow-lg'
                            : isDarkMode ? 'bg-gray-600' : 'bg-gray-300'
                        }`}
                      >
                        <span
                          className={`inline-block h-5 w-5 transform rounded-full bg-white transition-transform duration-200 shadow-sm ${
                            fuzzySearchEnabled ? 'translate-x-6' : 'translate-x-1'
                          }`}
                        />
                      </button>
                    </div>
                    
                    {/* Search Results */}
                    {searchResults.length > 0 && (
                      <div className="mt-6 max-h-80 overflow-y-auto space-y-3">
                        <p className="text-sm opacity-70 font-medium">
                          {searchResults.length} Ergebnis{searchResults.length > 1 ? 'se' : ''} gefunden
                          {fuzzySearchEnabled && ' (inkl. ähnliche Wörter)'}
                        </p>
                        {searchResults.map((result, index) => (
                          <div
                            key={index}
                            onClick={() => goToDate(result.date)}
                            className={`p-4 rounded-xl cursor-pointer transition-all duration-200 transform hover:scale-102 ${
                              isDarkMode
                                ? 'bg-gray-700 hover:bg-gray-600 shadow-lg'
                                : 'bg-white hover:bg-gray-50 shadow-md hover:shadow-lg'
                            }`}
                          >
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center space-x-3">
                                <span className="text-sm font-bold text-blue-500">
                                  {result.displayDate}
                                </span>
                                {result.mood && (
                                  <span className="text-lg">
                                    {getMoodDisplay(result.mood).emoji}
                                  </span>
                                )}
                              </div>
                              <div className="flex items-center space-x-2">
                                {result.matches.some(m => m.isFuzzy) && (
                                  <span className="text-xs px-3 py-1 rounded-full bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300 font-medium">
                                    ähnlich
                                  </span>
                                )}
                                <span className="text-xs opacity-60 font-medium">
                                  {result.matches.length} Treffer
                                </span>
                              </div>
                            </div>
                            <div className="space-y-2">
                              {result.matches.map((match, matchIndex) => (
                                <div key={matchIndex} className="text-sm">
                                  <span className="font-semibold opacity-80">
                                    {match.title}:
                                  </span>
                                  <span className={`ml-2 ${match.isFuzzy ? 'opacity-75' : 'opacity-90'}`}>
                                    {match.context}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    
                    {searchQuery && searchResults.length === 0 && (
                      <div className="mt-6 text-center py-8">
                        <div className="text-4xl mb-2">🔍</div>
                        <p className="text-sm opacity-60">
                          Keine Einträge gefunden für "{searchQuery}"
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Settings Panel */}
              {showSettings && (
                <div className={`p-4 border-b transition-all duration-300 ${
                  isDarkMode ? 'bg-gray-800/95 border-gray-700' : 'bg-white/95 border-gray-200'
                }`}>
                  <div className="space-y-6">
                    <div className="flex items-center justify-between">
                      <h3 className="text-lg font-bold">Einstellungen</h3>
                      <button
                        onClick={() => setIsEditingTitles(!isEditingTitles)}
                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200 ${
                          isDarkMode 
                            ? 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg' 
                            : 'bg-blue-500 hover:bg-blue-600 text-white shadow-md'
                        }`}
                      >
                        {isEditingTitles ? 'Fertig' : 'Felder bearbeiten'}
                      </button>
                    </div>
                    
                    {isEditingTitles && (
                      <div className="space-y-4">
                        <p className="text-sm opacity-70 font-medium">Titel der drei Eingabefelder:</p>
                        {fieldTitles.map((title, index) => (
                          <div key={index} className="flex items-center space-x-3">
                            {getEntryIcon(index)}
                            <input
                              type="text"
                              value={title}
                              onChange={(e) => {
                                const newTitles = [...fieldTitles];
                                newTitles[index] = e.target.value;
                                setFieldTitles(newTitles);
                              }}
                              className={`flex-1 px-4 py-3 rounded-xl border-0 transition-all duration-200 ${
                                isDarkMode
                                  ? 'bg-gray-700 text-white placeholder-gray-400 focus:bg-gray-600'
                                  : 'bg-gray-100 text-gray-900 placeholder-gray-500 focus:bg-white'
                              } focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm focus:shadow-md`}
                              placeholder={`Feld ${index + 1} Titel`}
                            />
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Calendar */}
              {showCalendar && (
                <div className={`p-4 border-b transition-all duration-300 ${
                  isDarkMode ? 'bg-gray-800/95 border-gray-700' : 'bg-white/95 border-gray-200'
                }`}>
                  <input
                    type="date"
                    value={formatDate(currentDate)}
                    onChange={(e) => {
                      setCurrentDate(new Date(e.target.value + 'T00:00:00'));
                      setShowCalendar(false);
                    }}
                    className={`w-full px-4 py-3 rounded-xl border-0 transition-all duration-200 ${
                      isDarkMode
                        ? 'bg-gray-700 text-white focus:bg-gray-600'
                        : 'bg-gray-100 text-gray-900 focus:bg-white'
                    } focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm focus:shadow-md`}
                  />
                </div>
              )}

              {/* Main Content */}
              <div className="p-6 space-y-8 pb-12">
                {/* Mood Selector */}
                <div className="space-y-4">
                  <label className="block text-sm font-bold opacity-80 flex items-center space-x-2">
                    <Heart className="w-4 h-4" />
                    <span>Wie war dein Tag?</span>
                  </label>
                  <div className="grid grid-cols-3 gap-3">
                    {[1, 2, 3].map((moodValue) => {
                      const moodDisplay = getMoodDisplay(moodValue);
                      const isSelected = currentEntry.mood === moodValue;
                      return (
                        <button
                          key={moodValue}
                          onClick={() => updateMood(moodValue)}
                          className={`p-6 rounded-2xl transition-all duration-300 transform ${
                            isSelected
                              ? 'bg-gradient-to-br from-blue-500 to-purple-600 shadow-xl scale-105 text-white'
                              : isDarkMode
                                ? 'bg-gray-800 hover:bg-gray-700 shadow-lg hover:scale-105'
                                : 'bg-white hover:bg-gray-50 shadow-md hover:shadow-lg hover:scale-105'
                          }`}
                        >
                          <div className="text-center">
                            <div className="text-3xl mb-2">{moodDisplay.emoji}</div>
                            <div className={`text-sm font-bold ${
                              isSelected ? 'text-white' : moodDisplay.color
                            }`}>
                              {moodDisplay.label}
                            </div>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Entry Fields */}
                {fieldTitles.map((title, index) => (
                  <div key={index} className="space-y-3">
                    <label className="block text-sm font-bold opacity-80 flex items-center space-x-2">
                      {getEntryIcon(index)}
                      <span>{title}</span>
                    </label>
                    <textarea
                      value={currentEntry[`field${index + 1}`]}
                      onChange={(e) => updateEntry(`field${index + 1}`, e.target.value)}
                      rows={4}
                      className={`w-full px-6 py-4 rounded-2xl border-0 resize-none transition-all duration-200 ${
                        isDarkMode
                          ? 'bg-gray-800 text-white placeholder-gray-400 focus:bg-gray-750'
                          : 'bg-white text-gray-900 placeholder-gray-500 focus:bg-gray-50'
                      } shadow-md focus:shadow-xl focus:ring-2 focus:ring-blue-500 focus:outline-none`}
                      placeholder={`Deine ${title.toLowerCase()} für heute...`}
                    />
                  </div>
                ))}

                {/* Save Indicator */}
                <div className="text-center pt-4">
                  {getSaveStatusIndicator()}
                  <div className="mt-2 text-xs opacity-40">
                    🔒 Deine Daten werden nur lokal auf diesem Gerät gespeichert
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(React.createElement(DiaryApp), document.getElementById('root'));
    </script>
</body>
</html>
